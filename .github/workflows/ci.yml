name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          # Create a minimal .env file if it doesn't exist (for CI validation)
          if [ ! -f .env ]; then
            touch .env
          fi
          docker compose config > /dev/null
          echo "✅ Docker Compose configuration is valid"

      - name: Validate Kubernetes Manifests
        run: |
          if command -v kubectl &> /dev/null; then
            find k8s -name "*.yaml" -type f | while read file; do
              echo "Validating $file"
              kubectl apply --dry-run=client -f "$file" > /dev/null 2>&1 || echo "⚠️  Warning: $file validation skipped (kubectl not fully available)"
            done
          else
            echo "⚠️  kubectl not available, skipping K8s validation"
          fi

      - name: Check YAML syntax
        run: |
          find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | while read file; do
            echo "Checking $file"
            # Use safe_load_all for multi-document YAML files
            python3 -c "import yaml; list(yaml.safe_load_all(open('$file')))" || exit 1
          done || echo "⚠️  Python YAML check skipped"

      - name: Validate Makefile
        run: |
          make help > /dev/null
          echo "✅ Makefile is valid"

  test-dockerfiles:
    name: Test Dockerfile Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate ComfyUI Dockerfile
        run: |
          docker buildx build --dry-run \
            -f dockerfiles/Dockerfile.comfyui \
            --platform linux/amd64 \
            . || echo "⚠️  ComfyUI Dockerfile validation (build may require GPU)"

      - name: Validate SwarmUI Dockerfile
        run: |
          docker buildx build --dry-run \
            -f dockerfiles/Dockerfile.swarmui \
            --platform linux/amd64 \
            . || echo "⚠️  SwarmUI Dockerfile validation (build may require GPU)"

  test-scripts:
    name: Test Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh || true

      - name: Check script syntax
        run: |
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              echo "Checking $script"
              bash -n "$script" || exit 1
            fi
          done
          echo "✅ All scripts have valid syntax"

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          # Basic check for common secret patterns
          if grep -rE "(password|secret|token|api_key|apikey)\s*[=:]\s*['\"][^'\"]{10,}" --include="*.yml" --include="*.yaml" --include="*.sh" .; then
            echo "⚠️  Potential secrets found, please review"
            exit 1
          fi
          echo "✅ No obvious secrets found in code"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test-dockerfiles, test-scripts, security]
    if: always()
    steps:
      - name: CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfiles | ${{ needs.test-dockerfiles.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scripts | ${{ needs.test-scripts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY

  push-to-gitlab:
    name: Push to GitLab
    runs-on: ubuntu-latest
    needs: [lint, test-dockerfiles, test-scripts, security]
    if: always() && needs.lint.result == 'success' && needs.test-dockerfiles.result == 'success' && needs.test-scripts.result == 'success' && needs.security.result == 'success' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote remove gitlab 2>/dev/null || true
          git remote add gitlab https://gitlab.com/dk-raas/dkai/tools/freya.git
          git config credential.helper '!f() { echo "username=oauth2"; echo "password=${GITLAB_TOKEN}"; }; f'
          git fetch gitlab main
          git push gitlab HEAD:main --force
