name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          # Create a minimal .env file if it doesn't exist (for CI validation)
          if [ ! -f .env ]; then
            touch .env
          fi
          docker compose config > /dev/null
          echo "✅ Docker Compose configuration is valid"

      - name: Install kube-score
        run: |
          VERSION=$(curl -s https://api.github.com/repos/zegl/kube-score/releases/latest | grep tag_name | cut -d '"' -f 4 | tr -d 'v')
          curl -L "https://github.com/zegl/kube-score/releases/download/v${VERSION}/kube-score_${VERSION}_linux_amd64.tar.gz" -o kube-score.tar.gz
          tar -xzf kube-score.tar.gz
          sudo mv kube-score /usr/local/bin/
          kube-score version

      - name: Validate Kubernetes Manifests
        run: |
          ERROR_COUNT=0
          for file in $(find k8s -name "*.yaml" -type f); do
            echo "Validating $file with kube-score"
            if OUTPUT=$(kube-score score "$file" 2>&1); then
              echo "✅ $file passed kube-score validation"
              echo "$OUTPUT" | head -20
            else
              EXIT_CODE=$?
              echo "❌ $file validation failed (exit code: $EXIT_CODE)"
              echo "kube-score output:"
              echo "$OUTPUT"
              # kube-score exits with non-zero for warnings, but we'll treat it as a pass
              # Only fail on actual errors (CRITICAL issues)
              if echo "$OUTPUT" | grep -q "CRITICAL"; then
                ERROR_COUNT=$((ERROR_COUNT + 1))
              else
                echo "⚠️  $file has warnings but no critical issues"
              fi
            fi
            echo "---"
          done
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "❌ Validation failed for $ERROR_COUNT file(s) with CRITICAL issues"
            exit 1
          fi
          echo "✅ All Kubernetes manifests passed validation"

      - name: Check YAML syntax
        run: |
          find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | while read file; do
            echo "Checking $file"
            # Use safe_load_all for multi-document YAML files
            python3 -c "import yaml; list(yaml.safe_load_all(open('$file')))" || exit 1
          done || echo "⚠️  Python YAML check skipped"

      - name: Validate Makefile
        run: |
          make help > /dev/null
          echo "✅ Makefile is valid"

  test-dockerfiles:
    name: Test Dockerfile Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install hadolint
        run: |
          wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

      - name: Validate ComfyUI Dockerfile
        run: |
          echo "Validating dockerfiles/Dockerfile.comfyui..."
          hadolint dockerfiles/Dockerfile.comfyui || echo "⚠️  ComfyUI Dockerfile had linting warnings (non-blocking)"
          echo "✅ ComfyUI Dockerfile validation complete"

      - name: Validate SwarmUI Dockerfile
        run: |
          echo "Validating dockerfiles/Dockerfile.swarmui..."
          hadolint dockerfiles/Dockerfile.swarmui || echo "⚠️  SwarmUI Dockerfile had linting warnings (non-blocking)"
          echo "✅ SwarmUI Dockerfile validation complete"

  test-scripts:
    name: Test Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh || true

      - name: Check script syntax
        run: |
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              echo "Checking $script"
              bash -n "$script" || exit 1
            fi
          done
          echo "✅ All scripts have valid syntax"

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        run: |
          # Basic check for common secret patterns
          if grep -rE "(password|secret|token|api_key|apikey)\s*[=:]\s*['\"][^'\"]{10,}" --include="*.yml" --include="*.yaml" --include="*.sh" .; then
            echo "⚠️  Potential secrets found, please review"
            exit 1
          fi
          echo "✅ No obvious secrets found in code"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test-dockerfiles, test-scripts, security]
    if: always()
    steps:
      - name: CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfiles | ${{ needs.test-dockerfiles.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scripts | ${{ needs.test-scripts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY

  push-to-gitlab:
    name: Push to GitLab
    runs-on: ubuntu-latest
    needs: [lint, test-dockerfiles, test-scripts, security]
    if: always() && needs.lint.result == 'success' && needs.test-dockerfiles.result == 'success' && needs.test-scripts.result == 'success' && needs.security.result == 'success' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote remove gitlab 2>/dev/null || true
          git remote add gitlab https://gitlab.com/dk-raas/dkai/tools/freya.git
          git config credential.helper '!f() { echo "username=oauth2"; echo "password=${GITLAB_TOKEN}"; }; f'
          git fetch gitlab main
          git push gitlab HEAD:main --force
