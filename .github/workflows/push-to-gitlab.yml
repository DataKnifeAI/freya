name: Push to GitLab

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  push-to-gitlab:
    name: Mirror to GitLab
    runs-on: ubuntu-latest
    # Only run if CI workflow completed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha || github.ref }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch main

      - name: Verify GitLab token
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          if [ -z "$GITLAB_TOKEN" ]; then
            echo "❌ Error: GITLAB_TOKEN secret is not set"
            exit 1
          fi
          echo "✅ GitLab token is set (length: ${#GITLAB_TOKEN} characters)"
          
          # Test token by making an API call to verify it works and has access
          echo "Testing GitLab token permissions..."
          TOKEN_INFO=$(curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" "https://gitlab.com/api/v4/user")
          if [ $? -eq 0 ] && [ -n "$TOKEN_INFO" ]; then
            echo "✅ Token is valid and can access GitLab API"
            echo "User info: $(echo "$TOKEN_INFO" | grep -o '"username":"[^"]*"' | head -1 || echo 'retrieved')"
          else
            echo "⚠️  Token API test failed - token may be invalid or expired"
            echo "⚠️  Continuing anyway - git operations may still work"
          fi
          
          # Test project access
          echo "Testing project access..."
          PROJECT_ACCESS=$(curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "https://gitlab.com/api/v4/projects/dk-raas%2Fdkai%2Ftools%2Ffreya" 2>&1)
          if echo "$PROJECT_ACCESS" | grep -q "404\|403\|401"; then
            echo "⚠️  Warning: Cannot access project - token may lack permissions"
            echo "⚠️  Response: $(echo "$PROJECT_ACCESS" | head -c 200)"
          else
            echo "✅ Token has access to project"
          fi

      - name: Configure GitLab remote
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          # Fetch all branches
          git fetch origin
          
          # Ensure we're on main branch (create from origin/main if needed)
          if git show-ref --verify --quiet refs/heads/main; then
            git checkout main
            git reset --hard origin/main
          else
            git checkout -b main origin/main
          fi
          
          # Remove gitlab remote if it exists
          git remote remove gitlab 2>/dev/null || true
          
          # Add GitLab remote - use token directly (GitHub Actions handles secrets safely)
          # The token should be properly handled by the shell
          git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@gitlab.com/dk-raas/dkai/tools/freya.git"
          
          # Verify remote was added (mask token in output)
          git remote -v | sed 's/oauth2:[^@]*@/oauth2:***@/g'

      - name: Push to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GIT_TERMINAL_PROMPT: 0
        run: |
          git push gitlab main --force
