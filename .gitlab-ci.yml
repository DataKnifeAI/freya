stages:
  - lint
  - test
  - docker
  - release

variables:
  IMAGE_NAME_COMFYUI: freya-comfyui
  IMAGE_NAME_SWARMUI: freya-swarmui

lint:
  stage: lint
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache make bash python3 py3-pip
    - pip3 install pyyaml
  script:
    - echo "üîç Running lint checks..."
    - docker compose config > /dev/null && echo "‚úÖ Docker Compose valid"
    - make help > /dev/null && echo "‚úÖ Makefile valid"
    - find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | while read file; do
        echo "Checking $file"
        python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
      done || echo "‚ö†Ô∏è  YAML check skipped"
    - for script in scripts/*.sh; do
        if [ -f "$script" ]; then
          echo "Checking $script"
          bash -n "$script" || exit 1
        fi
      done
    - echo "‚úÖ All lint checks passed"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  tags:
    - kubernetes

test-scripts:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache make bash
  script:
    - echo "üß™ Testing scripts..."
    - chmod +x scripts/*.sh || true
    - for script in scripts/*.sh; do
        if [ -f "$script" ]; then
          echo "Testing $script syntax"
          bash -n "$script" || exit 1
        fi
      done
    - echo "‚úÖ Script tests passed"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  tags:
    - kubernetes

test-dockerfiles:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache make bash
  script:
    - echo "üê≥ Testing Dockerfiles..."
    - docker buildx create --use || true
    - docker buildx build --dry-run \
        -f dockerfiles/Dockerfile.comfyui \
        --platform linux/amd64 \
        . || echo "‚ö†Ô∏è  ComfyUI Dockerfile (build may require GPU)"
    - docker buildx build --dry-run \
        -f dockerfiles/Dockerfile.swarmui \
        --platform linux/amd64 \
        . || echo "‚ö†Ô∏è  SwarmUI Dockerfile (build may require GPU)"
    - echo "‚úÖ Dockerfile tests passed"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  tags:
    - kubernetes

publish-comfyui:
  stage: docker
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  script:
    - |
      # Use commit SHA if available, otherwise fall back to pipeline ID
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA:-$CI_PIPELINE_ID}"
      
      # Build and push images with BuildKit rootless (multiple outputs for multiple tags)
      OUTPUT_FLAGS="--output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_COMFYUI:latest,push=true"
      OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_COMFYUI:$IMAGE_TAG,push=true"
      
      # Add version tag if tag exists
      if [ -n "$CI_COMMIT_TAG" ]; then
        OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_COMFYUI:$CI_COMMIT_TAG,push=true"
      fi
      
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=dockerfiles/Dockerfile.comfyui \
        $OUTPUT_FLAGS
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - kubernetes

publish-swarmui:
  stage: docker
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  script:
    - |
      # Use commit SHA if available, otherwise fall back to pipeline ID
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA:-$CI_PIPELINE_ID}"
      
      # Build and push images with BuildKit rootless (multiple outputs for multiple tags)
      OUTPUT_FLAGS="--output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_SWARMUI:latest,push=true"
      OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_SWARMUI:$IMAGE_TAG,push=true"
      
      # Add version tag if tag exists
      if [ -n "$CI_COMMIT_TAG" ]; then
        OUTPUT_FLAGS="$OUTPUT_FLAGS --output type=image,name=$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME_SWARMUI:$CI_COMMIT_TAG,push=true"
      fi
      
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=dockerfiles/Dockerfile.swarmui \
        $OUTPUT_FLAGS
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  tags:
    - kubernetes

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: never                                  # Do not run this job when a tag is created manually
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Run this job when commits are pushed or merged to the default branch
  script:
    - |
      echo "Creating release for commit $CI_COMMIT_SHORT_SHA"
      echo "Release will create tag automatically"
  release:                               # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: 'v0.$CI_PIPELINE_IID'     # The version is incremented per pipeline
    description: 'Release v0.$CI_PIPELINE_IID'
    ref: '$CI_COMMIT_SHA'                # The tag is created from the pipeline SHA
  tags:
    - kubernetes
